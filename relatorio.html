<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Relat√≥rio de Campo - RSS3</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Outfit:wght@600;800&display=swap" rel="stylesheet">

<style>
/* --- VARI√ÅVEIS DE CORES E TEMA --- */
:root {
  --primary:#0078ff;
  --accent:#00b4ff;
  --bg:#f5f8fb;
  --card:#ffffff;
  --text:#1a1a1a;
  --muted:#666;
  --border:#e3e6eb;
  --shadow:0 8px 28px rgba(0,0,0,0.08);
  --danger: #ef4444;
  --success: #10b981;
}

.dark {
  --bg:#0f1419;
  --card:#1b2228;
  --text:#e8eef5;
  --muted:#a7b0bc;
  --border:#2b3139;
  --shadow:0 6px 22px rgba(0,0,0,0.6);
}

/* --- ESTILOS GERAIS --- */
* { box-sizing: border-box; font-family: "Inter", sans-serif; transition: background-color .18s ease, color .18s ease; }
body { margin: 0; background: var(--bg); color: var(--text); min-height: 100vh; display: flex; flex-direction: column; }

/* HEADER */
header {
  display: flex; justify-content: space-between; align-items: center;
  padding: 12px 16px; background: var(--card); border-bottom: 1px solid var(--border);
  box-shadow: var(--shadow); position: sticky; top: 0; z-index: 100;
}
header h1 { margin: 0; font-family: "Outfit"; font-weight: 800; font-size: 1.2rem; color: var(--primary); }

#themeToggle {
  width: 38px; height: 38px; border-radius: 10px; border: 1px solid var(--border);
  background: transparent; cursor: pointer; display: flex; align-items: center; justify-content: center;
}

/* CONTAINER PRINCIPAL */
main { flex: 1; max-width: 920px; margin: 20px auto; padding: 16px; width: 100%; }

/* AUDITORIA / NOTIFICA√á√ïES */
.audit-section { margin-bottom: 30px; }
.stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; margin-bottom: 20px; }
.stat-card { background: var(--card); padding: 15px; border-radius: 12px; border: 1px solid var(--border); text-align: center; }
.stat-card span { display: block; font-size: 0.7rem; color: var(--muted); text-transform: uppercase; margin-bottom: 5px; }
.stat-card b { font-size: 1.2rem; color: var(--primary); }

.notif-list { display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px; }
.card-notif {
  background: var(--card); padding: 14px; border-radius: 12px; border: 1px solid var(--border);
  border-left: 5px solid var(--primary); display: flex; align-items: center; gap: 12px;
  position: relative; animation: fadeIn 0.3s ease;
}
.card-notif.urgente { border-left-color: var(--danger); }
.btn-excluir-notif { position: absolute; top: 8px; right: 8px; background: none; border: none; color: var(--muted); cursor: pointer; font-size: 1.1rem; }

@keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

/* FORMUL√ÅRIO */
.card { background: var(--card); border-radius: 12px; padding: 20px; border: 1px solid var(--border); box-shadow: var(--shadow); }
h2 { margin: 0 0 15px; font-family: "Outfit"; font-weight: 800; color: var(--primary); font-size: 1.1rem; border-bottom: 1px solid var(--border); padding-bottom: 8px; }
.section-title { margin: 20px 0 10px; font-weight: 700; font-size: .95rem; color: var(--primary); display: flex; align-items: center; gap: 8px; }

.grid-2 { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; }

label { display: block; margin-top: 10px; font-weight: 600; font-size: .85rem; margin-bottom: 4px; }
input, select, textarea {
  width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border);
  background: transparent; color: var(--text); font-size: .9rem; outline: none;
}
.dark input, .dark select, .dark textarea { background: #232a30; border-color: #333a42; }

/* HOR√ÅRIOS */
.horario-row { display: flex; align-items: flex-end; gap: 8px; margin-top: 8px; }
.horario-row div { flex: 1; }
.btn-marcar {
  background: var(--primary); color: white; border: none; padding: 10px;
  border-radius: 8px; font-weight: 700; cursor: pointer; height: 38px; min-width: 80px;
}

/* BOT√ïES ESPECIAIS */
.quick-options { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 5px; }
.quick-btn {
  border-radius: 20px; border: 1px solid var(--border); background: rgba(0,120,255,0.05);
  padding: 4px 12px; font-size: .75rem; cursor: pointer; color: var(--primary); font-weight: 600;
}

.btn-main {
  background: linear-gradient(135deg, var(--primary), var(--accent));
  color: white; border: none; padding: 14px; border-radius: 10px;
  font-weight: 700; font-size: 1rem; cursor: pointer; width: 100%; margin-top: 20px;
}

/* FOTOS */
#imagePreview { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 12px; }
.thumb-wrapper { position: relative; width: 80px; height: 80px; }
.thumb-img { width: 100%; height: 100%; object-fit: cover; border-radius: 8px; }
.btn-del-foto {
  position: absolute; top: -5px; right: -5px; background: var(--danger);
  color: white; border: none; border-radius: 50%; width: 20px; height: 20px; cursor: pointer;
}

footer { text-align: center; padding: 20px; font-size: .8rem; color: var(--muted); }
</style>
</head>
<body>

<header>
  <h1>Sistema RSS3 - Relat√≥rio</h1>
  <button id="themeToggle" type="button">üåô</button>
</header>

<main>
  <section class="audit-section">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
      <h2 style="border:none; margin:0;">Central de Auditoria</h2>
      <input type="date" id="dataFiltro" style="width: auto;">
    </div>
    
    <div class="stats-grid">
      <div class="stat-card"><span>Enviados</span><b id="statEnviados">0</b></div>
      <div class="stat-card"><span>Pendentes</span><b id="statPendencias" style="color:var(--danger)">0</b></div>
      <div class="stat-card"><span>Analisando</span><b id="statData">--/--</b></div>
    </div>

    <div class="notif-list" id="listaNotificacoes"></div>
    <button class="btn-marcar" style="width:100%; margin-bottom: 20px;" onclick="verificarPendenciasReal()">üîÑ Sincronizar Dados</button>
  </section>

  <div class="card">
    <h2>Preencher Relat√≥rio</h2>

    <div class="section-title">Dados principais</div>
    <div class="grid-2">
      <div>
        <label>N√∫mero da PT</label>
        <input id="numeroPt" type="text" readonly placeholder="Gerando...">
      </div>
      <div>
        <label>Data</label>
        <input id="dataRelatorio" type="date">
      </div>
      <div>
        <label>Equipamento</label>
        <select id="equipamento">
          <option value="">Selecione...</option>
          <option value="Hidrojato">Hidrojato</option>
          <option value="Hidrov√°cuo">Hidrov√°cuo</option>
        </select>
      </div>
      <div>
        <label>Placa</label>
        <select id="placa">
          <option value="">Selecione...</option>
          <option value="FOQ6H01">FOQ6H01</option>
          <option value="IVR1B32">IVR1B32</option>
          <option value="JBK7F63">JBK7F63</option>
          <option value="PPC6I87">PPC6I87</option>
          <option value="outra">Outra (digitar)</option>
        </select>
      </div>
    </div>

    <div class="grid-2">
      <div>
        <label>Local</label>
        <input id="local" type="text" placeholder="Ex: CR1">
      </div>
      <div>
        <label>TAG</label>
        <input id="tag" type="text" placeholder="Ex: 571">
      </div>
      <div>
        <label>Solicitante</label>
        <input id="solicitante" type="text">
        <div class="quick-options">
          <button type="button" class="quick-btn" onclick="preencherCampo('solicitante', 'CMPC')">CMPC</button>
        </div>
      </div>
      <div>
        <label>Emitente Abertura</label>
        <input id="emitAbertura" type="text">
      </div>
      <div>
        <label>Emitente Encerramento</label>
        <input id="emitEncerramento" type="text">
      </div>
      <div>
        <label>Operador</label>
        <select id="operador">
          <option value="">Selecione...</option>
          <option value="Bruno Ramos">Bruno Ramos</option>
          <option value="Lucas Coelho">Lucas Coelho</option>
          <option value="Robson Silva">Robson Silva</option>
        </select>
      </div>
      <div>
        <label>Ajudante</label>
        <input id="ajudante" type="text">
      </div>
      <div>
        <label>Tipo de Servi√ßo</label>
        <input id="tipoServico" type="text">
      </div>
    </div>

    <div class="section-title">Hor√°rios detalhados</div>
    
    <div class="grid-2">
      <div class="horario-row">
        <div><label>DDS e Checklist</label><input id="h_dds" class="time-input" placeholder="00:00"></div>
        <button class="btn-marcar" onclick="marcarAgora('h_dds')">Marcar</button>
      </div>
      <div class="horario-row">
        <div><label>Coordena√ß√£o</label><input id="h_coord" class="time-input" placeholder="00:00"></div>
        <button class="btn-marcar" onclick="marcarAgora('h_coord')">Marcar</button>
      </div>
      <div class="horario-row">
        <div><label>Chegada ao Local</label><input id="h_chegada" class="time-input" placeholder="00:00"></div>
        <button class="btn-marcar" onclick="marcarAgora('h_chegada')">Marcar</button>
      </div>
      <div class="horario-row">
        <div><label>Libera√ß√£o PT</label><input id="h_liberacao" class="time-input" placeholder="00:00"></div>
        <button class="btn-marcar" onclick="marcarAgora('h_liberacao')">Marcar</button>
      </div>
      <div class="horario-row">
        <div><label>In√≠cio Atividade</label><input id="h_inicio" class="time-input" placeholder="00:00"></div>
        <button class="btn-marcar" onclick="marcarAgora('h_inicio')">Marcar</button>
      </div>
      <div class="horario-row">
        <div><label>Fim Atividade</label><input id="h_fim" class="time-input" placeholder="00:00"></div>
        <button class="btn-marcar" onclick="marcarAgora('h_fim')">Marcar</button>
      </div>
      <div class="horario-row">
        <div><label>In√≠cio Intervalo</label><input id="h_intervalo_ini" class="time-input" placeholder="00:00"></div>
        <button class="btn-marcar" onclick="marcarAgora('h_intervalo_ini')">Marcar</button>
      </div>
      <div class="horario-row">
        <div><label>Fim Intervalo</label><input id="h_intervalo_fim" class="time-input" placeholder="00:00"></div>
        <button class="btn-marcar" onclick="marcarAgora('h_intervalo_fim')">Marcar</button>
      </div>
      <div class="horario-row">
        <div><label>Troca de Turno</label><input id="h_troca" class="time-input" placeholder="00:00"></div>
        <button class="btn-marcar" onclick="marcarAgora('h_troca')">Marcar</button>
      </div>
    </div>

    <div class="section-title">Encerramento e Atividade</div>
    <div class="grid-2">
      <div>
        <label>Encerramento da PT?</label>
        <select id="encerramentoPt">
          <option value="Sim">Sim</option>
          <option value="N√£o">N√£o</option>
        </select>
      </div>
      <div>
        <label>Tipo</label>
        <select id="tipoAtividade">
          <option value="Limpeza">Limpeza</option>
          <option value="Descarte">Descarte</option>
          <option value="Suc√ß√£o">Suc√ß√£o</option>
        </select>
      </div>
      <div>
        <label>√ìleo</label>
        <select id="oleo">
          <option value="N√£o">N√£o</option>
          <option value="Sim">Sim</option>
        </select>
      </div>
      <div id="boxQuantidade" style="display:none;">
        <label>Quantidade de √ìleo</label>
        <input id="qtdOleo" type="text" placeholder="Ex: 500L">
      </div>
    </div>

    <div id="boxDescarte" style="display:none;">
        <label>Local de Descarte</label>
        <select id="localDescarte">
            <option value="IBCs">IBCs</option>
            <option value="Outros">Outros...</option>
        </select>
        <input id="localDescarteOutros" type="text" placeholder="Especifique..." style="display:none; margin-top:10px;">
    </div>

    <div class="section-title">Fotos (M√°x 5)</div>
    <button class="btn-marcar" type="button" onclick="document.getElementById('inputFotos').click()">üì∏ Adicionar Fotos</button>
    <input type="file" id="inputFotos" accept="image/*" multiple style="display:none">
    <div id="imagePreview"></div>

    <label>Observa√ß√µes</label>
    <textarea id="observacoes" rows="3" placeholder="Algo importante..."></textarea>

    <div class="grid-2" style="margin-top:20px;">
        <button class="btn-main" onclick="enviarRelatorio()">Salvar Relat√≥rio</button>
        <button class="btn-main" style="background:var(--muted);" onclick="limparTudo()">Limpar Campos</button>
    </div>
  </div>
</main>

<footer>¬© 2025 RSS3 - Sistema Integrado de Campo</footer>

<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

<script>
// CONFIG FIREBASE
const firebaseConfig = {
  apiKey: "AIzaSyCAfBANhkMec6TCGCO9JwrvOB79RbyLw8I",
  authDomain: "relatorio-rss3-15896.firebaseapp.com",
  projectId: "relatorio-rss3-15896",
  storageBucket: "relatorio-rss3-15896.firebasestorage.app",
  messagingSenderId: "905086909082",
  appId: "1:905086909082:web:7535afa8dddbd7b691fd23"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// MODO NOTURNO
const themeBtn = document.getElementById("themeToggle");
themeBtn.onclick = () => {
    document.body.classList.toggle("dark");
    themeBtn.textContent = document.body.classList.contains("dark") ? "‚òÄÔ∏è" : "üåô";
};

// M√ÅSCARA DE HOR√ÅRIO (0800 -> 08:00)
document.querySelectorAll('.time-input').forEach(el => {
    el.oninput = (e) => {
        let v = e.target.value.replace(/\D/g, "");
        if (v.length === 4) e.target.value = v.slice(0, 2) + ":" + v.slice(2);
        else e.target.value = v;
    };
});

// LOGICA DE CAMPOS DIN√ÇMICOS
document.getElementById("oleo").onchange = (e) => {
    document.getElementById("boxQuantidade").style.display = e.target.value === "Sim" ? "block" : "none";
    verificarDescarte();
};
document.getElementById("tipoAtividade").onchange = verificarDescarte;

function verificarDescarte() {
    const oleo = document.getElementById("oleo").value;
    const tipo = document.getElementById("tipoAtividade").value;
    document.getElementById("boxDescarte").style.display = (oleo === "Sim" && tipo === "Descarte") ? "block" : "none";
}

document.getElementById("localDescarte").onchange = (e) => {
    document.getElementById("localDescarteOutros").style.display = e.target.value === "Outros" ? "block" : "none";
};

// FUN√á√ïES AUXILIARES
function marcarAgora(id) {
    const d = new Date();
    document.getElementById(id).value = String(d.getHours()).padStart(2,'0') + ":" + String(d.getMinutes()).padStart(2,'0');
}

function preencherCampo(id, val) { document.getElementById(id).value = val; }

// FOTOS
let listaFotos = [];
document.getElementById("inputFotos").onchange = (e) => {
    const files = Array.from(e.target.files);
    files.slice(0, 5 - listaFotos.length).forEach(file => {
        const reader = new FileReader();
        reader.onload = (ev) => {
            listaFotos.push(ev.target.result);
            renderFotos();
        };
        reader.readAsDataURL(file);
    });
};

function renderFotos() {
    const p = document.getElementById("imagePreview");
    p.innerHTML = "";
    listaFotos.forEach((f, i) => {
        p.innerHTML += `<div class="thumb-wrapper"><img src="${f}" class="thumb-img"><button class="btn-del-foto" onclick="listaFotos.splice(${i},1);renderFotos()">√ó</button></div>`;
    });
}

// AUDITORIA E NOTIFICA√á√ïES
const inputFiltro = document.getElementById("dataFiltro");
inputFiltro.value = new Date(Date.now() - 86400000).toISOString().split('T')[0];

async function verificarPendenciasReal() {
    const dataAlvo = inputFiltro.value;
    const lista = document.getElementById("listaNotificacoes");
    const ignoradas = JSON.parse(localStorage.getItem('notif_ignoradas') || "[]");
    
    document.getElementById("statData").textContent = dataAlvo.split('-').reverse().join('/');
    lista.innerHTML = "Sincronizando...";

    try {
        const snap = await db.collection("relatoriosCampo").where("data", "==", dataAlvo).get();
        const rels = snap.docs.map(d => d.data());
        lista.innerHTML = "";
        let pends = 0;

        // Regra Turnos (Simples)
        const turnos = [
            {n: "Turno 1", h: "07:30"},
            {n: "Turno 2", h: "14:40"},
            {n: "Turno 3", h: "23:40"}
        ];

        turnos.forEach(t => {
            const id = `t-${t.n}-${dataAlvo}`;
            if (!ignoradas.includes(id)) {
                const existe = rels.some(r => (r.horarios?.inicio || "").startsWith(t.h.split(':')[0]));
                if (!existe) {
                    gerarCard(id, `Falta cobertura: ${t.n}`, `Nenhum relat√≥rio √†s ${t.h}`, "urgente");
                    pends++;
                }
            }
        });

        document.getElementById("statEnviados").textContent = rels.length;
        document.getElementById("statPendencias").textContent = pends;
    } catch(e) { console.error(e); }
}

function gerarCard(id, tit, msg, cls) {
    const div = document.createElement("div");
    div.className = `card-notif ${cls}`;
    div.innerHTML = `<button class="btn-excluir-notif" onclick="ignorarNotif('${id}', this)">√ó</button><b>${tit}</b><p>${msg}</p>`;
    document.getElementById("listaNotificacoes").prepend(div);
}

function ignorarNotif(id, btn) {
    const ign = JSON.parse(localStorage.getItem('notif_ignoradas') || "[]");
    ign.push(id);
    localStorage.setItem('notif_ignoradas', JSON.stringify(ign));
    btn.parentElement.remove();
}

// SALVAR RELAT√ìRIO
async function enviarRelatorio() {
    const pt = document.getElementById("numeroPt").value;
    const data = {
        numeroPt: pt,
        data: document.getElementById("dataRelatorio").value,
        operador: document.getElementById("operador").value,
        horarios: { inicio: document.getElementById("h_inicio").value, fim: document.getElementById("h_fim").value },
        fotos: listaFotos,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
    };
    
    try {
        await db.collection("relatoriosCampo").add(data);
        alert("Salvo!");
        location.reload();
    } catch(e) { alert("Erro!"); }
}

// AUTO GERAR PT
async function gerarPt() {
    const d = await db.collection("config").doc("contador").get();
    let num = (d.exists ? d.data().val : 100000) + 1;
    document.getElementById("numeroPt").value = num;
}

gerarPt();
verificarPendenciasReal();
</script>
</body>
</html>
