<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Relat√≥rio de Campo</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Outfit:wght@600;800&display=swap" rel="stylesheet">

<style>
/* --- ESTILOS (Mantidos do seu c√≥digo original) --- */
:root{
  --primary:#0078ff;
  --accent:#00b4ff;
  --bg:#f5f8fb;
  --card:#ffffff;
  --text:#1a1a1a;
  --muted:#666;
  --border:#e3e6eb;
  --shadow:0 8px 28px rgba(0,0,0,0.08);
}
.dark{
  --bg:#0f1419;
  --card:#1b2228;
  --text:#e8eef5;
  --muted:#a7b0bc;
  --border:#2b3139;
  --shadow:0 6px 22px rgba(0,0,0,0.6);
}
*{box-sizing:border-box;font-family:"Inter",sans-serif;transition:background-color .18s ease,color .18s ease,border-color .18s ease;}
body{margin:0;background:var(--bg);color:var(--text);min-height:100vh;display:flex;flex-direction:column;}
header{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;background:var(--card);border-bottom:1px solid var(--border);box-shadow:var(--shadow);position:sticky;top:0;z-index:10;}
header h1{margin:0;font-family:"Outfit";font-weight:800;font-size:1.2rem;color:var(--primary);}
#themeToggle{width:38px;height:38px;border-radius:10px;border:1px solid var(--border);background:transparent;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:1.1rem;}
main{flex:1;max-width:920px;margin:20px auto;padding:16px;}
.card{background:var(--card);border-radius:12px;padding:16px;border:1px solid var(--border);box-shadow:var(--shadow);}
h2{margin:0 0 10px;font-family:"Outfit";font-weight:800;color:var(--primary);font-size:1.1rem;}
.section-title{margin:18px 0 8px;font-weight:700;font-size:.95rem;color:var(--primary);}
label{display:block;margin-top:10px;font-weight:600;font-size:.85rem;}
input,select,textarea{width:100%;padding:9px 10px;border-radius:8px;border:1px solid var(--border);background:transparent;color:var(--text);font-size:.9rem;outline:none;}
textarea{resize:vertical;min-height:70px;}
input::placeholder,textarea::placeholder{color:#9aa4b2;}
.dark input,.dark select,.dark textarea{background:#232a30;border-color:#333a42;color:#eaf0f7;}
.dark input::placeholder,.dark textarea::placeholder{color:#aeb9c4;}
.grid-2{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px;}
.horario-row{display:flex;align-items:center;gap:8px;margin-top:8px;}
.horario-row input{flex:1;}
.horario-row button{flex:0 0 120px;}
.btn{background:linear-gradient(135deg,var(--primary),var(--accent));color:#fff;border:none;padding:11px 14px;border-radius:10px;font-weight:700;font-size:.95rem;cursor:pointer;}
.btn:hover{transform:translateY(-1px);}
.btn-sec{background:#ddd;color:#222;}
.quick-options{display:flex;flex-wrap:wrap;gap:6px;margin-top:4px;}
.quick-btn{border-radius:999px;border:1px solid var(--border);background:rgba(15,23,42,0.03);padding:4px 9px;font-size:.75rem;cursor:pointer;color:var(--muted);}
.dark .quick-btn{background:#232a30;border-color:#333a42;color:#e5e7eb;}
.quick-btn:hover{background:rgba(0,120,255,0.06);}
#imagePreview{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px;}
.thumb-img{width:120px;height:80px;object-fit:cover;border-radius:8px;box-shadow:0 4px 14px rgba(0,0,0,0.25);cursor:zoom-in;}
footer{text-align:center;padding:12px;font-size:.8rem;color:var(--muted);background:var(--card);border-top:1px solid var(--border);}
.toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);padding:8px 14px;border-radius:999px;background:#111827;color:#f9fafb;font-size:.78rem;font-weight:600;display:none;z-index:9999;box-shadow:0 8px 20px rgba(0,0,0,0.45);}
.toast.show{display:block;}
@media(max-width:600px){main{padding:10px;} .horario-row button{flex:0 0 100px;font-size:.75rem;padding:9px;}}
.time-input{font-family:inherit;}
</style>
</head>
<body>

<header>
  <h1>Relat√≥rio de Campo</h1>
  <button id="themeToggle" type="button">üåô</button>
</header>

<main>
  <div class="card">
    <h2>Preencher Relat√≥rio</h2>

    <div class="section-title">Dados principais</div>
    <div class="grid-2">
      <div>
        <label>N√∫mero da PT</label>
        <input id="numeroPt" type="text" autocomplete="off">
      </div>
      <div>
        <label>Data</label>
        <input id="data" type="date" autocomplete="off">
      </div>
      <div>
        <label>Equipamento</label>
        <select id="equipamento">
          <option value="Hidrojato">Hidrojato</option>
          <option value="Hidrovacuo">Hidrov√°cuo</option>
        </select>
      </div>
      <div>
        <label>Placa</label>
        <select id="placaSelect">
          <option value="IVR1B32">IVR1B32</option>        
          <option value="LRA8855">LRA8855</option>
          <option value="SKID">SKID</option>
          <option value="PPC6I87">PPC6I87</option>
          <option value="TDK6G18">TDK6G18</option>
          <option value="KPR0F00">KPR0F00</option>
          <option value="outra">Outra (digitar)</option>
        </select>
        <input id="placaTexto" type="text" placeholder="Digite a placa..." style="margin-top:6px;display:none;" autocomplete="off">
      </div>
    </div>

    <div class="grid-2">
      <div>
        <label>Local</label>
        <input id="local" type="text" autocomplete="off">
      </div>
      <div>
        <label>TAG</label>
        <input id="tag" type="text" autocomplete="off">
      </div>
      <div>
        <label>Solicitante</label>
        <input id="solicitante" type="text" autocomplete="off">
        <div class="quick-options">
          <button type="button" class="quick-btn" data-fill-target="solicitante" data-fill-value="CMPC">CMPC</button>
        </div>
      </div>
      <div>
        <label>Emitente abertura</label>
        <input id="emitAbertura" type="text" autocomplete="off">
      </div>
      <div>
        <label>Emitente encerramento</label>
        <input id="emitEncerramento" type="text" autocomplete="off">
      </div>
      <div>
        <label>Operador</label>
        <select id="operadorSelect">
          <option value="Bruno Ramos">Bruno Ramos</option>
          <option value="Carlos Alexandre">Carlos Alexandre</option>
          <option value="Jaques">Jaques</option>
          <option value="J√∫lio C√©sar">J√∫lio C√©sar</option>
          <option value="Lucas Coelho">Lucas Coelho</option>
          <option value="Robson Silva">Robson Silva</option>
          <option value="outra">Outro (digitar)</option>
        </select>
        <input id="operadorTexto" type="text" placeholder="Digite o nome do operador..." style="margin-top:6px;display:none;" autocomplete="off">
      </div>
      <div>
        <label>Ajudante</label>
        <input id="ajudante" type="text" autocomplete="off">
      </div>
      <div>
        <label>Tipo de servi√ßo</label>
        <input id="tipoServico" type="text" placeholder="Ex.: Limpeza de caixa..." autocomplete="off">
      </div>
    </div>

    <div class="section-title">Hor√°rios</div>

    <div class="horario-row">
      <div style="flex:1;">
        <label>DDS e Checklist</label>
        <input id="h_ddsChecklist" class="time-input" type="text" placeholder="__:__" autocomplete="off" inputmode="numeric">
      </div>
      <button class="btn" type="button" data-horario="h_ddsChecklist">Marcar</button>
    </div>

    <div class="horario-row">
      <div style="flex:1;">
        <label>Disposi√ß√£o da coordena√ß√£o</label>
        <input id="h_disposicao" class="time-input" type="text" placeholder="__:__" autocomplete="off" inputmode="numeric">
      </div>
      <button class="btn" type="button" data-horario="h_disposicao">Marcar</button>
    </div>

    <div class="horario-row">
      <div style="flex:1;">
        <label>Chegada ao local</label>
        <input id="h_chegada" class="time-input" type="text" placeholder="__:__" autocomplete="off" inputmode="numeric">
      </div>
      <button class="btn" type="button" data-horario="h_chegada">Marcar</button>
    </div>

    <div class="horario-row">
      <div style="flex:1;">
        <label>Libera√ß√£o da PT</label>
        <input id="h_liberacaoPT" class="time-input" type="text" placeholder="__:__" autocomplete="off" inputmode="numeric">
      </div>
      <button class="btn" type="button" data-horario="h_liberacaoPT">Marcar</button>
    </div>

    <div class="horario-row">
      <div style="flex:1;">
        <label>In√≠cio da atividade</label>
        <input id="h_inicio" class="time-input" type="text" placeholder="__:__" autocomplete="off" inputmode="numeric">
      </div>
      <button class="btn" type="button" data-horario="h_inicio">Marcar</button>
    </div>

    <div class="horario-row">
      <div style="flex:1;">
        <label>Fim da atividade</label>
        <input id="h_fim" class="time-input" type="text" placeholder="__:__" autocomplete="off" inputmode="numeric">
      </div>
      <button class="btn" type="button" data-horario="h_fim">Marcar</button>
    </div>

    <div class="horario-row">
      <div style="flex:1;">
        <label>In√≠cio intervalo</label>
        <input id="h_inicioIntervalo" class="time-input" type="text" placeholder="__:__" autocomplete="off" inputmode="numeric">
      </div>
      <button class="btn" type="button" data-horario="h_inicioIntervalo">Marcar</button>
    </div>

    <div class="horario-row">
      <div style="flex:1;">
        <label>Fim intervalo</label>
        <input id="h_fimIntervalo" class="time-input" type="text" placeholder="__:__" autocomplete="off" inputmode="numeric">
      </div>
      <button class="btn" type="button" data-horario="h_fimIntervalo">Marcar</button>
    </div>

    <div class="horario-row">
      <div style="flex:1;">
        <label>Troca de turno</label>
        <input id="h_trocaTurno" class="time-input" type="text" placeholder="__:__" autocomplete="off" inputmode="numeric">
      </div>
      <button class="btn" type="button" data-horario="h_trocaTurno">Marcar</button>
    </div>

    <div class="section-title">Encerramento da PT</div>
    <div class="grid-2">
      <div>
        <label>Encerramento da PT?</label>
        <select id="encerramentoPt">
          <option value="Sim">Sim</option>
          <option value="N√£o">N√£o</option>
        </select>
      </div>
      <div id="boxMotivoNao" style="display:none;">
        <label>Por que n√£o foi finalizada?</label>
        <input id="motivoNaoFinalizada" type="text" autocomplete="off">
      </div>
    </div>

    <div class="section-title">Especifica√ß√µes da atividade</div>
    <div class="grid-2">
      <div>
        <label>Tipo</label>
        <select id="tipoAtividade">
          <option value="Suc√ß√£o">Suc√ß√£o</option>
          <option value="Descarte">Descarte</option>
          <option value="Hidrojato">Hidrojato</option>
        </select>
      </div>
      <div>
        <label>√ìleo</label>
        <select id="oleo">
          <option value="Sim">Sim</option>
          <option value="N√£o">N√£o</option>
        </select>
      </div>
      <div id="boxQuantidade" style="display:none;">
        <label>Quantidade (se tiver √≥leo)</label>
        <input id="quantidade" type="text" placeholder="Ex.: 500 L" autocomplete="off">
      </div>
    </div>

    <div id="boxDescartes" style="display:none; margin-top:8px;">
      <label>Onde foi descartado?</label>
      <select id="ondeDescartadoTipo">
        <option value="IBCs">IBCs</option>
        <option value="Outros">Outros</option>
      </select>
      <div id="boxOndeOutros" style="display:none; margin-top:8px;">
        <input id="ondeDescartadoTexto" type="text" placeholder="Descreva o local (ex.: lago, caixa, tanque...)" autocomplete="off">
      </div>
    </div>

    <div class="section-title">Fotos</div>
    <div style="display:flex;gap:10px;align-items:center;margin-top:6px;flex-wrap:wrap;">
      <button id="btnAddFoto" class="btn" type="button">Adicionar foto</button>
      <input id="inputFotos" type="file" accept="image/*" multiple style="display:none">
      <span style="font-size:.75rem;color:var(--muted);">M√°x. 5 fotos</span>
    </div>
    <div id="imagePreview"></div>

    <label style="margin-top:16px;">Observa√ß√µes</label>
    <textarea id="observacoes" placeholder="Algo importante sobre a atividade..." autocomplete="off"></textarea>

    <div style="margin-top:18px;display:flex;gap:10px;flex-wrap:wrap;">
      <button id="btnSalvar" class="btn" type="button">Salvar relat√≥rio</button>
      <button id="btnLimpar" class="btn btn-sec" type="button">Limpar campos</button>
    </div>
  </div>
</main>

<footer>
  ¬© 2025 | Relat√≥rios de Campo ‚Äî RSS3
</footer>

<div id="toast" class="toast"></div>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
<script>
// ==========================================================
// ‚≠ê ATUALIZADO: Usando as credenciais do novo projeto: relatorio-rss3-15896
// ==========================================================
const firebaseConfig = {
  apiKey: "AIzaSyCAfBANhkMec6TCGCO9JwrvOB79RbyLw8I",
  authDomain: "relatorio-rss3-15896.firebaseapp.com",
  projectId: "relatorio-rss3-15896",
  storageBucket: "relatorio-rss3-15896.firebasestorage.app",
  messagingSenderId: "905086909082",
  appId: "1:905086909082:web:7535afa8dddbd7b691fd23",
  measurementId: "G-EPGW3FGXX5"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// -----------------------------------------------------------
// ‚≠ê CORRE√á√ÉO PRINCIPAL: Garante que o DOM esteja carregado
// antes de tentar adicionar Event Listeners aos bot√µes
// -----------------------------------------------------------
document.addEventListener("DOMContentLoaded", function() {
  
  /* ===== THEME ===== */
  const themeToggle=document.getElementById("themeToggle");
  if(localStorage.getItem("tema")==="dark"){
    document.body.classList.add("dark");
    themeToggle.textContent="‚òÄÔ∏è";
  }
  themeToggle.onclick=()=>{
    document.body.classList.toggle("dark");
    const dark=document.body.classList.contains("dark");
    themeToggle.textContent=dark?"‚òÄÔ∏è":"üåô";
    localStorage.setItem("tema",dark?"dark":"light");
  };

  /* ===== TOAST ===== */
  const toastEl=document.getElementById("toast");
  function showToast(msg,color){
    toastEl.textContent=msg;
    toastEl.style.background=color || "#111827";
    toastEl.classList.add("show");
    setTimeout(()=>toastEl.classList.remove("show"),2800);
  }

  /* ===== Helpers device/id/rascunho (mantive seu c√≥digo) ===== */
  function getDeviceId(){
    let id=localStorage.getItem("deviceId_relatorios");
    if(!id){
      id="dev-"+Math.random().toString(36).slice(2,10);
      localStorage.setItem("deviceId_relatorios",id);
    }
    return id;
  }
  function getOperadorIdFixo(){
    let id=localStorage.getItem("operadorIdFixo_relatorios");
    if(!id){
      id="op-"+Math.random().toString(36).slice(2,10);
      localStorage.setItem("operadorIdFixo_relatorios",id);
    }
    return id;
  }

  /* ===== FUN√á√ÉO DE COMPRESS√ÉO (ADICIONADA PARA FUNCIONAR FOTOS) ===== */
  function compressImage(base64Str) {
    return new Promise((resolve) => {
      const img = new Image();
      img.src = base64Str;
      img.onload = () => {
        const canvas = document.createElement('canvas');
        const MAX_WIDTH = 800;
        const MAX_HEIGHT = 600;
        let width = img.width;
        let height = img.height;

        if (width > height) {
          if (width > MAX_WIDTH) {
            height *= MAX_WIDTH / width;
            width = MAX_WIDTH;
          }
        } else {
          if (height > MAX_HEIGHT) {
            width *= MAX_HEIGHT / height;
            height = MAX_HEIGHT;
          }
        }
        canvas.width = width;
        canvas.height = height;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, width, height);
        resolve(canvas.toDataURL('image/jpeg', 0.7)); // Qualidade 70%
      };
    });
  }

  /* ===== RASCUNHO LOCAL (mantive) ===== */
  const DRAFT_KEY = "relatorioCampo_rascunho";
  let numeroPtAtual=null;
  let fotosSelecionadas=[];

  function $(id){return document.getElementById(id);}

  /* Save/load rascunho (mantive seu c√≥digo ‚Äî inalterado estruturalmente) */
  function saveDraft(){
    try{
      const draft={
        numeroPtAtual,
        numeroPt: $("numeroPt").value,
        data: $("data").value,
        equipamento: $("equipamento").value,
        placaSelect: $("placaSelect").value,
        placaTexto: $("placaTexto").value,
        local: $("local").value,
        tag: $("tag").value,
        solicitante: $("solicitante").value,
        emitAbertura: $("emitAbertura").value,
        emitEncerramento: $("emitEncerramento").value,
        operadorSelect: $("operadorSelect").value,
        operadorTexto: $("operadorTexto").value,
        ajudante: $("ajudante").value,
        tipoServico: $("tipoServico").value,
        tipoAtividade: $("tipoAtividade").value,
        oleo: $("oleo").value,
        quantidade: $("quantidade").value,
        encerramentoPt: $("encerramentoPt").value,
        motivoNaoFinalizada: $("motivoNaoFinalizada").value,
        ondeDescartadoTipo: $("ondeDescartadoTipo").value,
        ondeDescartadoTexto: $("ondeDescartadoTexto").value,
        horarios:{
          ddsChecklist: $("h_ddsChecklist").value,
          disposicao: $("h_disposicao").value,
          chegada: $("h_chegada").value,
          liberacaoPT: $("h_liberacaoPT").value,
          inicio: $("h_inicio").value,
          inicioIntervalo: $("h_inicioIntervalo").value,
          fimIntervalo: $("h_fimIntervalo").value,
          fim: $("h_fim").value,
          trocaTurno: $("h_trocaTurno").value
        },
        observacoes: $("observacoes").value,
        fotos: fotosSelecionadas
      };
      localStorage.setItem(DRAFT_KEY, JSON.stringify(draft));
    }catch(e){
      console.warn("Erro ao salvar rascunho:",e);
    }
  }
  function loadDraft(){
    try{
      const raw=localStorage.getItem(DRAFT_KEY);
      if(!raw) return false;
      const d=JSON.parse(raw);
      if(d.numeroPt) $("numeroPt").value=d.numeroPt;
      if(d.numeroPtAtual) numeroPtAtual=d.numeroPtAtual;
      if(d.data) $("data").value=d.data;
      if(d.equipamento) $("equipamento").value=d.equipamento;
      if(d.placaSelect){
        $("placaSelect").value=d.placaSelect;
        if(d.placaSelect==="outra") $("placaTexto").style.display="block";
      }
      if(d.placaTexto) $("placaTexto").value=d.placaTexto;
      if(d.local) $("local").value=d.local;
      if(d.tag) $("tag").value=d.tag;
      if(d.solicitante) $("solicitante").value=d.solicitante;
      if(d.emitAbertura) $("emitAbertura").value=d.emitAbertura;
      if(d.emitEncerramento) $("emitEncerramento").value=d.emitEncerramento;
      if(d.operadorSelect){
        $("operadorSelect").value=d.operadorSelect;
        if(d.operadorSelect==="outra") $("operadorTexto").style.display="block";
      }
      if(d.operadorTexto) $("operadorTexto").value=d.operadorTexto;
      if(!d.operadorSelect && d.operador){
        $("operadorSelect").value="outra";
        $("operadorTexto").style.display="block";
        $("operadorTexto").value=d.operador;
      }
      if(d.ajudante) $("ajudante").value=d.ajudante;
      if(d.tipoServico) $("tipoServico").value=d.tipoServico;
      if(d.tipoAtividade) $("tipoAtividade").value=d.tipoAtividade;
      if(d.oleo){
        $("oleo").value=d.oleo;
        if(d.oleo==="Sim") $("boxQuantidade").style.display="block";
      }
      if(d.quantidade) $("quantidade").value=d.quantidade;
      if(d.encerramentoPt){
        $("encerramentoPt").value=d.encerramentoPt;
        if(d.encerramentoPt==="N√£o") $("boxMotivoNao").style.display="block";
      }
      if(d.motivoNaoFinalizada) $("motivoNaoFinalizada").value=d.motivoNaoFinalizada;
      if(d.ondeDescartadoTipo) $("ondeDescartadoTipo").value=d.ondeDescartadoTipo;
      if(d.ondeDescartadoTexto) $("ondeDescartadoTexto").value=d.ondeDescartadoTexto;
      if(d.horarios){
        $("h_ddsChecklist").value=d.horarios.ddsChecklist || "";
        $("h_disposicao").value=d.horarios.disposicao || "";
        $("h_chegada").value=d.horarios.chegada || "";
        $("h_liberacaoPT").value=d.horarios.liberacaoPT || "";
        $("h_inicio").value=d.horarios.inicio || "";
        $("h_inicioIntervalo").value=d.horarios.inicioIntervalo || "";
        $("h_fimIntervalo").value=d.horarios.fimIntervalo || "";
        $("h_fim").value=d.horarios.fim || "";
        $("h_trocaTurno").value=d.horarios.trocaTurno || "";
      }
      fotosSelecionadas = Array.isArray(d.fotos) ? d.fotos : [];
      renderPreview();
      updateDescartesBoxVisibility();
      if($("ondeDescartadoTipo").value==="Outros") $("boxOndeOutros").style.display="block";
      return true;
    }catch(e){
      console.warn("Erro ao carregar rascunho:",e);
      return false;
    }
  }

  /* ===== Numero PT auto (mantive seu c√≥digo) ===== */
  async function gerarNumeroPt(){
    try{
      const docRef=db.collection("config").doc("contadorPTCampo");
      const prox=await db.runTransaction(async(tx)=>{
        const snap=await tx.get(docRef);
        let atual=99999;
        if(snap.exists && typeof snap.data().valor==="number"){
          atual=snap.data().valor;
        }
        const novo=atual+1;
        tx.set(docRef,{valor:novo});
        return novo;
      });
      numeroPtAtual=prox;
      if(!$("numeroPt").value){
        $("numeroPt").value=prox;
      }
      saveDraft();
    }catch(err){
      console.error("Erro ao gerar n√∫mero PT:",err);
      alert("Erro ao gerar n√∫mero da PT. Ver console.");
    }
  }

  /* Data padr√£o hoje */
  function setDataHoje(){
    const hoje=new Date();
    const ano=hoje.getFullYear();
    const mes=String(hoje.getMonth()+1).padStart(2,"0");
    const dia=String(hoje.getDate()).padStart(2,"0");
    $("data").value=`${ano}-${mes}-${dia}`;
  }

  /* Placa / Operador / √ìleo / Descartes (mantive) */
  const placaSelect=$("placaSelect");
  const placaTexto=$("placaTexto");
  placaSelect.addEventListener("change",()=>{
    if(placaSelect.value==="outra"){
      placaTexto.style.display="block";
    }else{
      placaTexto.style.display="none";
      placaTexto.value="";
    }
    saveDraft();
  });
  const operadorSelect=$("operadorSelect");
  const operadorTexto=$("operadorTexto");
  operadorSelect.addEventListener("change",()=>{
    if(operadorSelect.value==="outra"){
      operadorTexto.style.display="block";
    }else{
      operadorTexto.style.display="none";
      operadorTexto.value="";
    }
    saveDraft();
  });
  const oleoSelect=$("oleo");
  const boxQuantidade=$("boxQuantidade");
  const boxDescartes=$("boxDescartes");
  const tipoAtividadeSelect=$("tipoAtividade");
  const ondeDescartadoTipoEl=$("ondeDescartadoTipo");
  const ondeDescartadoTextoEl=$("ondeDescartadoTexto");
  const boxOndeOutros=$("boxOndeOutros");
  function updateDescartesBoxVisibility(){
    const tipoVal=tipoAtividadeSelect.value;
    const oleoVal=oleoSelect.value;
    if(tipoVal==="Descarte" && oleoVal==="Sim"){
      boxDescartes.style.display="block";
    }else{
      boxDescartes.style.display="none";
      ondeDescartadoTipoEl.value="";
      ondeDescartadoTextoEl.value="";
      boxOndeOutros.style.display="none";
    }
  }
  oleoSelect.addEventListener("change",()=>{
    if(oleoSelect.value==="Sim"){
      boxQuantidade.style.display="block";
    }else{
      boxQuantidade.style.display="none";
      $("quantidade").value="";
    }
    updateDescartesBoxVisibility();
    saveDraft();
  });
  tipoAtividadeSelect.addEventListener("change",()=>{
    updateDescartesBoxVisibility();
    saveDraft();
  });
  ondeDescartadoTipoEl.addEventListener("change",()=>{
    if(ondeDescartadoTipoEl.value==="Outros"){
      boxOndeOutros.style.display="block";
    }else{
      boxOndeOutros.style.display="none";
      ondeDescartadoTextoEl.value="";
    }
    saveDraft();
  });
  const encerramentoPtSelect=$("encerramentoPt");
  const boxMotivoNao=$("boxMotivoNao");
  const motivoNaoEl=$("motivoNaoFinalizada");
  encerramentoPtSelect.addEventListener("change",()=>{
    if(encerramentoPtSelect.value==="N√£o"){
      boxMotivoNao.style.display="block";
    }else{
      boxMotivoNao.style.display="none";
      motivoNaoEl.value="";
    }
    saveDraft();
  });

  /* ===== BOT√ïES "Marcar" com hora atual (mantive) ===== */
  function formatHoraAgora(){
    const agora=new Date();
    const hh=String(agora.getHours()).padStart(2,"0");
    const mm=String(agora.getMinutes()).padStart(2,"0");
    return `${hh}:${mm}`;
  }
  document.querySelectorAll('button[data-horario]').forEach(btn=>{
    btn.addEventListener("click",()=>{
      const id=btn.getAttribute("data-horario");
      const campo=$(id);
      campo.value=formatHoraAgora();
      saveDraft();
    });
  });

  /* ===== QUICK FILL (Solicitante) ===== */
  document.querySelectorAll("[data-fill-target]").forEach(btn=>{
    btn.addEventListener("click",()=>{
      const targetId=btn.getAttribute("data-fill-target");
      const value=btn.getAttribute("data-fill-value") || btn.textContent.trim();
      const input=$(targetId);
      if(input){
        input.value=value;
        saveDraft();
      }
    });
  });

  /* ===== FOTOS (MODIFICADO APENAS PARA COMPRESS√ÉO) ===== */
  const btnAddFoto=$("btnAddFoto");
  const inputFotos=$("inputFotos");
  const imagePreview=$("imagePreview");
  btnAddFoto.addEventListener("click",()=>inputFotos.click());
  inputFotos.addEventListener("change",(e)=>{
    const files=Array.from(e.target.files||[]);
    files.slice(0,5-fotosSelecionadas.length).forEach(file=>{
      const reader=new FileReader();
      reader.onload=async ev=>{
        // COMPRIME A IMAGEM ANTES DE ADICIONAR
        const compressed = await compressImage(ev.target.result);
        fotosSelecionadas.push(compressed);
        renderPreview();
        saveDraft();
      };
      reader.readAsDataURL(file);
    });
    inputFotos.value="";
  });
  function renderPreview(){
    imagePreview.innerHTML="";
    fotosSelecionadas.forEach((src,i)=>{
      const img=document.createElement("img");
      img.src=src;
      img.className="thumb-img";
      img.alt="Foto "+(i+1);
      img.onclick=()=>{
        const ov=document.createElement("div");
        ov.style.position="fixed";
        ov.style.inset="0";
        ov.style.background="rgba(0,0,0,0.85)";
        ov.style.display="flex";
        ov.style.alignItems="center";
        ov.style.justifyContent="center";
        ov.style.zIndex="9999";
        ov.style.cursor="zoom-out";
        const big=document.createElement("img");
        big.src=src;
        big.style.maxWidth="92%";
        big.style.maxHeight="92%";
        ov.appendChild(big);
        ov.onclick=()=>ov.remove();
        document.body.appendChild(ov);
      };
      imagePreview.appendChild(img);
    });
  }

  // ------------------------------------------------------------------
  // ‚≠ê NOVA FUN√á√ÉO: Limpar todos os campos do relat√≥rio
  // ------------------------------------------------------------------
  function limparCamposRelatorio(){
    document.querySelectorAll("input,textarea,select").forEach(el=>{
      if(el.type==="date") return;
      el.value="";
    });
    $("placaTexto").style.display="none";
    $("operadorTexto").style.display="none";
    $("oleo").value="";
    $("boxQuantidade").style.display="none";
    $("encerramentoPt").value="";
    $("boxMotivoNao").style.display="none";
    $("boxDescartes").style.display="none";
    $("boxOndeOutros").style.display="none";
    fotosSelecionadas=[];
    renderPreview();
    localStorage.removeItem(DRAFT_KEY);
    setDataHoje(); // Garante que a data do novo relat√≥rio seja a de hoje
  }
  // ------------------------------------------------------------------

  /* ===== LIMPAR CAMPOS ===== */
  $("btnLimpar").addEventListener("click",()=>{
    if(!confirm("Limpar todos os campos do relat√≥rio?")) return;
    limparCamposRelatorio(); // Chama a nova fun√ß√£o de limpeza
  });

  /* ===== Dia da semana / duracao (mantive) ===== */
  function getDiaSemana(dataStr){
    if(!dataStr) return "";
    const [ano,mes,dia]=dataStr.split("-").map(Number);
    const d=new Date(ano,mes-1,dia);
    const nomes=["Domingo","Segunda","Ter√ßa","Quarta","Quinta","Sexta","S√°bado"];
    return nomes[d.getDay()]||"";
  }
  function calcularDuracaoMin(hInicio,hFim){
    if(!hInicio || !hFim) return null;
    const [hi,mi]=hInicio.split(":").map(Number);
    const [hf,mf]=hFim.split(":").map(Number);
    if([hi,mi,hf,mf].some(v=>isNaN(v))) return null;
    const inicio=hi*60+mi;
    const fim=hf*60+mf;
    const diff=fim-inicio;
    return diff>0?diff:null;
  }

  /* =============== M√ÅSCARA INTELIGENTE PARA CAMPOS DE HORA =========== */
  function attachTimeMask(el){
    if(!el) return;
    el.addEventListener("input",(e)=>{
      const raw = el.value || "";
      // remove tudo que n√£o √© d√≠gito
      let digits = raw.replace(/\D/g,"").slice(0,4); // no m√°ximo 4 d√≠gitos HHMM
      if(digits.length===0){
        el.value = ""; // vazio ‚Äî n√£o coloca 00:00
        return;
      }
      if(digits.length<=2){
        el.value = digits; // mostra os primeiros d√≠gitos (sem dois pontos ainda)
      }else{
        el.value = digits.slice(0,2) + ":" + digits.slice(2);
      }
    },false);

    // evita colar conte√∫do com caracteres estranhos
    el.addEventListener("paste",(e)=>{
      e.preventDefault();
      const text = (e.clipboardData || window.clipboardData).getData("text");
      const digits = (text||"").replace(/\D/g,"").slice(0,4);
      if(!digits) { el.value=""; return; }
      if(digits.length<=2) el.value = digits;
      else el.value = digits.slice(0,2) + ":" + digits.slice(2);
    },false);
  }

  // Aplica m√°scara a todos inputs com classe time-input
  document.querySelectorAll(".time-input").forEach(attachTimeMask);

  /* ===== Valida√ß√£o de hor√°rio: retorna true se formato HH:MM e minutos<60 e horas 0-23 ===== */
  function validarHoraFormatada(v){
    if(!v || typeof v !== "string") return false;
    if(!v.includes(":")) return false;
    const [hh,mm]=v.split(":");
    if(hh.length!==2 || mm.length!==2) return false;
    if(!/^\d{2}$/.test(hh) || !/^\d{2}$/.test(mm)) return false;
    const H=parseInt(hh,10);
    const M=parseInt(mm,10);
    if(H<0 || H>23) return false;
    if(M<0 || M>59) return false;
    return true;
  }

  /* ===== SALVAR RELAT√ìRIO (com valida√ß√£o extra de hor√°rios) ===== */
  const btnSalvar=$("btnSalvar");
  btnSalvar.addEventListener("click",async()=>{
    const numeroPtInput=$("numeroPt").value.trim();
    const data=$("data").value;
    const equipamento=$("equipamento").value;
    const placaSel=placaSelect.value;
    const placa = placaSel==="outra" ? placaTexto.value.trim() : placaSel;
    const local=$("local").value.trim();
    const tag=$("tag").value.trim();
    const solicitante=$("solicitante").value.trim();
    const emitAbertura=$("emitAbertura").value.trim();
    const emitEncerramento=$("emitEncerramento").value.trim();
    const operadorSel=operadorSelect.value;
    const operadorTxt=operadorTexto.value.trim();
    const operador = operadorSel==="outra" ? operadorTxt : operadorSel;
    const ajudante=$("ajudante").value.trim();
    const tipoServico=$("tipoServico").value.trim();
    const tipoAtividade=$("tipoAtividade").value;
    const oleo=$("oleo").value;
    const quantidade=$("quantidade").value.trim();
    const obs=$("observacoes").value.trim();
    const encerramentoPt=encerramentoPtSelect.value;
    const motivoNao=motivoNaoEl.value.trim();
    const ondeTipo=ondeDescartadoTipoEl.value;
    const ondeTexto=ondeDescartadoTextoEl.value.trim();

    if(!numeroPtInput){
      alert("Informe o n√∫mero da PT.");
      return;
    }
    if(
      !data || !equipamento || !placa ||
      !local || !tag || !solicitante ||
      !emitAbertura || !emitEncerramento ||
      !operador || !ajudante || !tipoServico
    ){
      alert("Preencha todos os campos principais (dados e pessoas).");
      return;
    }
    if(!tipoAtividade){
      alert("Selecione o tipo da atividade.");
      return;
    }
    if(oleo===""){
      alert("Informe se houve √≥leo (Sim ou N√£o).");
      return;
    }
    if(oleo==="Sim" && !quantidade){
      alert("Informe a quantidade de √≥leo.");
      return;
    }
    if(tipoAtividade==="Descarte" && oleo==="Sim"){
      if(!ondeTipo){
        alert('Informe em "Onde foi descartado?" (IBCs ou Outros).');
        return;
      }
      if(ondeTipo==="Outros" && !ondeTexto){
        alert('Descreva o local do descarte em "Outros".');
        return;
      }
    }
    if(!encerramentoPt){
      alert("Informe se houve encerramento da PT (Sim ou N√£o).");
      return;
    }
    if(encerramentoPt==="N√£o" && !motivoNao){
      alert('Preencha o campo "Por que n√£o foi finalizada?".');
      return;
    }

    // Coleta hor√°rios
    const horariosIds = [
      "h_ddsChecklist","h_disposicao","h_chegada","h_liberacaoPT",
      "h_inicio","h_inicioIntervalo","h_fimIntervalo","h_fim","h_trocaTurno"
    ];
    const horariosObj = {};
    for(const id of horariosIds){
      horariosObj[id] = $(id).value.trim();
    }

    // Se encerramentoPt = Sim -> exige todos os hor√°rios e valida formato HH:MM
    if(encerramentoPt==="Sim"){
      for(const id of horariosIds){
        const v = horariosObj[id];
        if(!v){
          alert("Preencha todos os hor√°rios (DDS, coordena√ß√£o, chegada, libera√ß√£o, in√≠cio/fim, intervalo, troca de turno).");
          return;
        }
        if(!validarHoraFormatada(v)){
          alert(`Hor√°rio inv√°lido em "${id}". Use o formato HH:MM (ex: 08:30).`);
          return;
        }
      }
    } else {
      // mesmo que n√£o seja obrigat√≥rio, caso preenchido valida o formato
      for(const id of horariosIds){
        const v=horariosObj[id];
        if(v && !validarHoraFormatada(v)){
          alert(`Hor√°rio inv√°lido em "${id}". Use o formato HH:MM ou deixe vazio.`);
          return;
        }
      }
    }

    let duracaoMinutos=null;
    if(encerramentoPt==="Sim"){
      duracaoMinutos=calcularDuracaoMin(horariosObj.h_inicio,horariosObj.h_fim);
    }

    const diaSemana=getDiaSemana(data);
    const payload={
      numeroPT:String(numeroPtInput),
      data,
      diaSemana,
      equipamento,
      placa,
      local,
      tag,
      solicitante,
      emitenteAbertura:emitAbertura,
      emitenteEncerramento:emitEncerramento,
      operador,
      ajudante,
      tipoServico,
      horarios:{
        ddsChecklist:horariosObj.h_ddsChecklist,
        disposicao:horariosObj.h_disposicao,
        chegada:horariosObj.h_chegada,
        liberacaoPT:horariosObj.h_liberacaoPT,
        inicio:horariosObj.h_inicio,
        inicioIntervalo:horariosObj.h_inicioIntervalo,
        fimIntervalo:horariosObj.h_fimIntervalo,
        fim:horariosObj.h_fim,
        trocaTurno:horariosObj.h_trocaTurno
      },
      especificacoes:{
        tipoAtividade,
        oleo,
        quantidade,
        tipoServico,
        ondeDescartadoTipo: ondeTipo || "",
        ondeDescartadoTexto: ondeTexto || ""
      },
      encerramentoPt,
      motivoNaoFinalizada: encerramentoPt==="N√£o" ? motivoNao : "",
      observacoes:obs,
      fotos:fotosSelecionadas,
      duracaoMinutos,
      criadoEm:firebase.firestore.FieldValue.serverTimestamp(),
      deviceId:getDeviceId(),
      operadorIdFixo:getOperadorIdFixo()
    };

    if(!navigator.onLine){
      showToast("Sem internet. O relat√≥rio continua salvo neste aparelho.", "#eab308");
      return;
    }

    try{
      btnSalvar.disabled=true;
      btnSalvar.textContent="Salvando...";
      
      // Salva no Firestore
      await db.collection("relatoriosCampo").add(payload);
      
      // Mostra sucesso e limpa o formul√°rio
      showToast("‚úÖ Relat√≥rio salvo com sucesso!", "#10b981");
      limparCamposRelatorio();
      
      // Garante que a PT volte a ser gerada (se n√£o tiver uma no local)
      if(!$("numeroPt").value || $("numeroPt").value.toString() === numeroPtInput.toString()){
          gerarNumeroPt();
      }

    }catch(err){
      console.error("Erro ao salvar relat√≥rio:",err);
      showToast("Erro ao salvar relat√≥rio. Verifique a conex√£o.", "#dc2626");
    }finally{
      btnSalvar.disabled=false;
      btnSalvar.textContent="Salvar relat√≥rio";
    }
  });

  /* ===== AUTOSAVE: listeners em todos os campos ===== */
  const camposAutosave = [
    "numeroPt","data","equipamento","placaSelect","placaTexto","local","tag",
    "solicitante","emitAbertura","emitEncerramento",
    "operadorSelect","operadorTexto",
    "ajudante","tipoServico","tipoAtividade","oleo","quantidade",
    "encerramentoPt","motivoNaoFinalizada",
    "ondeDescartadoTipo","ondeDescartadoTexto",
    "h_ddsChecklist","h_disposicao","h_chegada","h_liberacaoPT",
    "h_inicio","h_inicioIntervalo","h_fimIntervalo","h_fim","h_trocaTurno",
    "observacoes"
  ];
  camposAutosave.forEach(id=>{
    const el=$(id);
    if(!el) return;
    ["input","change"].forEach(ev=>{
      el.addEventListener(ev, saveDraft);
    });
  });

  /* ===== Init (mantive) ===== */
  (function init(){
    renderPreview(); // caso tenha fotos
    const temDraft = loadDraft();
    if(!temDraft){
      setDataHoje();
      gerarNumeroPt();
    }else{
      if(!$("numeroPt").value){
        gerarNumeroPt();
      }
    }
  })();

}); // Fim do DOMContentLoaded
</script>
</body>
</html>
